<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ZYRA | NFT Studio</title>
  <meta name="description" content="ZYRA NFT Studio — ultra‑advanced minting, collections, rarity engine, and on‑chain deployment." />
  <meta name="theme-color" content="#22c55e" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@400;600;700&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
  <style>
    :root { --q-primary:#00ff95; --q-secondary:#16a34a; --q-accent:#84cc16; --q-success:#22c55e; --q-danger:#ef4444; --q-bg-0:#050607; --q-bg-1:#0a0f0a; --glass:rgba(255,255,255,.06); --glass-strong:rgba(255,255,255,.10); --glass-border:rgba(255,255,255,.14); --text:#e8fcea; --text-dim:#a9f5c9; --shadow-q:0 10px 50px rgba(34,197,94,.25); --grid-line:#b7f5d1; --chart-grid:rgba(74,222,128,.10); --chart-grid-weak:rgba(74,222,128,.06); --chart-tick:#c5ffde; --tooltip-bg:rgba(6,12,10,.92); --tooltip-title:#eafff2; --tooltip-body:#d5ffe8; --tooltip-border:rgba(134,239,172,.25); }
    *{box-sizing:border-box}
    body{margin:0;color:var(--text);background: radial-gradient(1200px 800px at 15% 10%, #0b1a12 0%, transparent 60%), radial-gradient(1000px 900px at 95% 0%, #08140c 0%, transparent 55%), linear-gradient(180deg, #040605 0%, #040605 100%); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto; }
    .animated-bg{position:fixed;inset:-20vmax;z-index:-2;filter:blur(80px) saturate(140%);opacity:.5;background:conic-gradient(from 180deg at 50% 50%,var(--q-primary),var(--q-secondary),var(--q-accent),var(--q-primary));animation:swirl 30s linear infinite}
    @keyframes swirl{to{transform:rotate(360deg)}}
    header{position:sticky;top:0;z-index:50;backdrop-filter:blur(12px);background:linear-gradient(180deg,rgba(8,12,24,.85),rgba(8,12,24,.6));border-bottom:1px solid var(--glass-border)}
    .wrap{max-width:1200px;margin:0 auto;padding:.9rem 1.25rem;display:flex;align-items:center;gap:1rem}
    .brand{display:flex;align-items:center;gap:.75rem;text-decoration:none;color:var(--text)}
    .logo{width:44px;height:44px;border-radius:14px;position:relative;overflow:hidden;box-shadow:0 0 0 1px #145532,var(--shadow-q);background:radial-gradient(120% 120% at 10% 10%,#0f2a1a 0%,#0a1510 60%,#070e0a 100%)}
    .logo::before{content:'';position:absolute;inset:-40%;background:conic-gradient(from 0deg,transparent 0 40%,#22ff88 50%,transparent 60% 100%);animation:spin 5s linear infinite;filter:blur(6px);opacity:.9}
    .logo::after{content:'Z';position:absolute;inset:0;display:grid;place-items:center;font-family:Orbitron;font-weight:900;font-size:22px;color:#eafff2;text-shadow:0 0 12px #22ff88;letter-spacing:.08em}
    @keyframes spin{to{transform:rotate(360deg)}}
    nav{margin-left:auto;display:flex;gap:.5rem;flex-wrap:wrap}
    .nav-btn{position:relative;padding:.55rem .9rem;border-radius:12px;border:1px solid var(--glass-border);background:var(--glass);color:var(--text);font-weight:600;cursor:pointer}
    .nav-btn.active{border-color:#22c55eaa;box-shadow:0 0 0 1px #22c55e55,var(--shadow-q);background:linear-gradient(180deg,rgba(34,197,94,.12),rgba(34,197,94,.06))}
    .pill{padding:.45rem .7rem;border-radius:999px;background:var(--glass);border:1px solid var(--glass-border);font-family:'JetBrains Mono',monospace;font-size:.85rem;color:var(--text-dim)}
    .cta{padding:.6rem 1rem;border-radius:12px;background:linear-gradient(90deg,var(--q-primary),var(--q-secondary));border:0;color:#021412;font-weight:800;letter-spacing:.04em;cursor:pointer}

    main{max-width:1200px;margin:1.2rem auto 2rem;padding:0 1.25rem}
    .h-title{font-family:Orbitron,Inter,sans-serif;font-weight:900;font-size:clamp(1.8rem,4.5vw,3rem);margin:.2rem 0 .2rem;letter-spacing:.06em;background:linear-gradient(120deg,#eafff2 10%,var(--q-primary) 45%,var(--q-secondary) 60%,#e7ffe3 90%);-webkit-background-clip:text;background-clip:text;color:transparent}
    .h-sub{color:var(--text-dim);margin:0 0 1rem}

    .studio{display:grid;grid-template-columns: 320px 1fr; gap:1rem}
    .panel{background:var(--glass);border:1px solid var(--glass-border);border-radius:16px;padding:1rem}
    .panel h3{margin:.2rem 0 1rem}
    .field{display:grid;gap:.35rem;margin:.6rem 0}
    .field label{font-weight:600}
    .field input,.field textarea,.field select{padding:.6rem .7rem;border-radius:12px;border:1px solid var(--glass-border);background:rgba(0,0,0,.25);color:var(--text)}
    .row{display:grid;grid-template-columns:1fr 1fr; gap:.6rem}
    .btn{padding:.55rem .9rem;border-radius:12px;border:1px solid var(--glass-border);background:var(--glass);color:var(--text);font-weight:700;cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,var(--q-primary),var(--q-secondary));border:0;color:#021412}
    .btn-success{background:linear-gradient(90deg,#22c55e,#16a34a);border:0;color:#021412}

    .preview{display:grid;grid-template-columns: repeat(auto-fill, minmax(140px,1fr)); gap:.6rem}
    .thumb{position:relative;background:rgba(0,0,0,.25);border:1px solid var(--glass-border);border-radius:12px;aspect-ratio:1/1;display:grid;place-items:center;color:#a9f5c9;font-family:'JetBrains Mono',monospace}

    .layers{display:grid;gap:.6rem}
    .layer{border:1px dashed rgba(255,255,255,.16);border-radius:12px;padding:.6rem}
    .layer h4{margin:.1rem 0 .4rem}
    .traits{display:grid;gap:.3rem}
    .trait{display:grid;grid-template-columns: 1fr 80px 80px 120px auto; gap:.4rem}

    .gallery{margin-top:1rem;display:grid;grid-template-columns: repeat(auto-fill, minmax(160px,1fr)); gap:.75rem}
    .item{position:relative;border:1px solid var(--glass-border);border-radius:14px;overflow:hidden;background:rgba(0,0,0,.25)}
    .item canvas{display:block;width:100%;height:auto}
    .item .cap{position:absolute;left:0;right:0;bottom:0;padding:.35rem .5rem;background:linear-gradient(180deg,transparent,rgba(0,0,0,.65));font-family:'JetBrains Mono',monospace;font-size:.8rem}

    .tools { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:1rem; margin-top:1rem }
    .tool { background:var(--glass); border:1px solid var(--glass-border); border-radius:16px; padding:1rem }
    .tool h3{ margin:.2rem 0 1rem }
    .tool .field textarea{ min-height:110px }
    .progress { height:10px; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden; border:1px solid var(--glass-border) }
    .progress .bar { height:100%; width:0%; background:linear-gradient(90deg, var(--q-primary), var(--q-secondary)); box-shadow: var(--shadow-q) }
    .muted { color: var(--text-dim); font-size:.85rem }
    @media(max-width:1100px){ .tools{ grid-template-columns:1fr; } }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
  <div class="animated-bg" aria-hidden="true"></div>
  <header>
    <div class="wrap">
      <a class="brand" href="index.html" aria-label="ZYRA Home">
        <div class="logo" aria-hidden="true"></div>
        <div class="wordmark" style="font-family:Orbitron;font-weight:900;letter-spacing:.12em;"> <span style="background:linear-gradient(90deg,var(--q-primary),var(--q-secondary));-webkit-background-clip:text;background-clip:text;color:transparent;">ZYRA</span>&nbsp;NFT STUDIO</div>
      </a>
      <nav aria-label="Primary">
        <a class="nav-btn" href="index.html">Home</a>
        <a class="nav-btn" href="defi.html">DeFi</a>
        <a class="nav-btn" href="analytics.html">Analytics</a>
        <a class="nav-btn" href="marketplace.html">Marketplace</a>
        <span class="nav-btn active" aria-current="page">NFT</span>
      </nav>
      <div class="wallet">
        <div id="walletState" class="pill">Not Connected</div>
        <button id="walletBtn" class="cta">Connect Wallet</button>
      </div>
    </div>
  </header>

  <main>
    <h1 class="h-title">NFT Studio — Ultra‑Advanced</h1>
    <p class="h-sub">Design layered collections, compute rarity, preview thousands, upload metadata and deploy ERC‑721/1155 with a click.</p>

    <section class="studio">
      <aside class="panel">
        <h3>Collection</h3>
        <div class="field"><label for="colName">Name</label><input id="colName" placeholder="My Quantum Collection"/></div>
        <div class="field"><label for="colSymbol">Symbol</label><input id="colSymbol" placeholder="QNFT"/></div>
        <div class="field"><label for="colStandard">Standard</label>
          <select id="colStandard" title="Token Standard">
            <option value="ERC721" selected>ERC-721</option>
            <option value="ERC1155">ERC-1155</option>
          </select>
        </div>
        <div class="field"><label for="colSupply">Supply</label><input id="colSupply" type="number" value="5000" min="1" placeholder="Total Supply" title="Total Supply"/></div>
        <div class="field"><label for="colRoyalty">Royalty %</label><input id="colRoyalty" type="number" value="5" min="0" max="25" step="0.1" placeholder="Royalty percentage" title="Royalty percentage"/></div>
        <div class="field"><label for="colBase">Base URI</label><input id="colBase" placeholder="ipfs://..."/></div>
        <div class="field" id="erc1155SupplyField" style="display:none"><label for="col1155Supply">Per‑token supply (ERC‑1155)</label><input id="col1155Supply" type="number" min="1" value="1" title="Supply per tokenId (ERC-1155)"/></div>
        <div class="row">
          <div class="field"><label for="colPrice">Mint Price (ETH)</label><input id="colPrice" type="number" step="0.0001" min="0" value="0" placeholder="0.05" title="Mint price in ETH"/></div>
          <div class="field"><label for="colMax">Max / Wallet</label><input id="colMax" type="number" min="0" value="0" placeholder="0 for unlimited" title="Max mints per wallet"/></div>
        </div>
        <div class="field"><label for="colStart">Sale Start</label><input id="colStart" type="datetime-local" title="Public sale start date/time"/></div>
        <div class="row">
          <button class="btn" id="btnRarity">Compute Rarity</button>
          <button class="btn" id="btnPreview">Generate Preview</button>
        </div>
        <div class="row" style="margin-top:.5rem">
          <button class="btn-primary btn" id="btnExport">Export Metadata</button>
          <button class="btn-success btn" id="btnDeploy">Deploy</button>
        </div>
        <div class="row" style="margin-top:.5rem">
          <button class="btn" id="btnSave" title="Save project locally">Save Project</button>
          <button class="btn" id="btnLoad" title="Load saved project">Load Project</button>
        </div>
        <p class="muted">Tip: Switch to ERC-1155 for semi-fungible collections. Pricing and limits apply to public sale.</p>
      </aside>

      <section class="panel">
        <h3>Layers & Traits</h3>
        <div class="layers" id="layers"></div>
        <div class="row" style="margin-top:.5rem">
          <button class="btn" id="btnAddLayer">Add Layer</button>
          <button class="btn" id="btnAddTrait">Add Trait</button>
        </div>
        <div class="preview" id="preview"></div>
      </section>
    </section>

    <!-- Ultra-advanced tools: whitelist, rules, rarity, generator -->
    <section class="tools">
      <div class="tool">
        <h3>Whitelist & Merkle Root</h3>
        <div class="field"><label for="wlList">Addresses (one per line)</label><textarea id="wlList" placeholder="0xabc...\n0xdef..."></textarea></div>
        <div class="row">
          <button class="btn" id="btnMerkle">Compute Merkle Root</button>
          <input class="pill" id="wlRoot" readonly placeholder="0x..." title="Merkle root" />
        </div>
        <p class="muted">Use this root in your contract to enable whitelist mints.</p>
      </div>
      <div class="tool">
        <h3>Rules Engine</h3>
        <div class="field"><label for="rules">Incompatibilities</label><textarea id="rules" placeholder="LayerA:Trait1 != LayerB:Trait2\nBackground:Red != Eyes:Laser"></textarea></div>
        <div class="row">
          <button class="btn" id="btnCheckRules">Validate Rules</button>
          <span id="rulesStatus" class="pill" title="Rules status">No rules</span>
        </div>
        <p class="muted">Rules block specific trait combinations during generation.</p>
      </div>
      <div class="tool">
        <h3>Rarity Visualization</h3>
        <canvas id="rarChart" height="160"></canvas>
        <p class="muted">Weighted trait distribution across all layers.</p>
      </div>
      <div class="tool">
        <h3>Provenance</h3>
        <div class="row">
          <button class="btn" id="btnProv">Compute Provenance</button>
          <input class="pill" id="provHash" readonly placeholder="0x..." title="Provenance hash" />
        </div>
        <p class="muted">Keccak256 of the current configuration (collection + layers).</p>
      </div>
      <div class="tool">
        <h3>IPFS Upload (web3.storage)</h3>
        <div class="field"><label for="ipfsToken">API Token</label><input id="ipfsToken" placeholder="web3.storage token" title="web3.storage API token"/></div>
        <div class="row">
          <button class="btn" id="btnUploadMeta" title="Upload metadata/ folder">Upload Metadata Only</button>
          <button class="btn" id="btnUploadAll" title="Upload entire ZIP">Upload Full ZIP</button>
        </div>
        <div class="row" style="margin-top:.5rem">
          <input class="pill" id="ipfsCid" readonly placeholder="CID" title="Resulting CID" />
        </div>
        <p class="muted">Preserves folder structure. Use after generating a collection.</p>
      </div>
    </section>

    <section class="tool" style="margin-top:1rem">
      <h3>Bulk Generator & ZIP Export</h3>
      <div class="row">
        <div class="field"><label for="genCount">Items to generate</label><input id="genCount" type="number" min="1" value="100" /></div>
        <div class="field"><label for="genSize">Thumbnail size (px)</label><input id="genSize" type="number" min="64" value="512" /></div>
      </div>
      <div class="row">
        <label class="pill" style="display:flex;align-items:center;gap:.5rem"><input id="genUnique" type="checkbox" checked /> Enforce uniqueness (DNA)</label>
        <label class="pill" style="display:flex;align-items:center;gap:.5rem"><input id="genImages" type="checkbox" /> Include thumbnails in ZIP</label>
        <label class="pill" style="display:flex;align-items:center;gap:.5rem"><input id="genWorker" type="checkbox" /> Use Web Worker (metadata)</label>
      </div>
      <div class="row" style="margin-top:.5rem">
        <button class="btn" id="btnGenerate">Generate Collection</button>
        <button class="btn-primary btn" id="btnDownload" disabled>Download ZIP</button>
      </div>
      <div class="progress" style="margin-top:.6rem"><div class="bar" id="genBar"></div></div>
      <p id="genNote" class="muted">Ready.</p>
    </section>
  </main>

  <script>
    // Wallet
    (function wallet(){
      const btn=document.getElementById('walletBtn'); const state=document.getElementById('walletState'); let connected=false; let addr=''; let provider=null;
      async function connect(){ if(typeof window.ethereum==='undefined'){ alert('MetaMask not detected.'); return; } try{ provider=new ethers.providers.Web3Provider(window.ethereum,'any'); await provider.send('eth_requestAccounts',[]); const signer=provider.getSigner(); addr=await signer.getAddress(); connected=true; state.textContent=addr.slice(0,6)+'...'+addr.slice(-4); state.style.background='rgba(34,197,94,.15)'; btn.textContent='Disconnect'; const bal=await provider.getBalance(addr); state.title = `Balance: ${ethers.utils.formatEther(bal)} ETH`; window.ethereum.on('accountsChanged', handleAccounts); window.ethereum.on('chainChanged', ()=>location.reload()); }catch(err){ alert('Wallet connection failed: '+(err?.message||err)); } }
      function disconnect(){ connected=false; addr=''; state.textContent='Not Connected'; state.style.background='var(--glass)'; state.title=''; btn.textContent='Connect Wallet'; try{ window.ethereum?.removeListener('accountsChanged', handleAccounts);}catch{} }
      async function handleAccounts(accounts){ if(!accounts||!accounts.length){ disconnect(); return;} addr=accounts[0]; state.textContent=addr.slice(0,6)+'...'+addr.slice(-4); if(provider){ const bal=await provider.getBalance(addr); state.title=`Balance: ${ethers.utils.formatEther(bal)} ETH`; } }
      btn.addEventListener('click', async()=>{ if(!connected) await connect(); else disconnect(); });
    })();

    // NFT Studio logic
    const layersEl = document.getElementById('layers');
    const previewEl = document.getElementById('preview');
    const galleryEl = document.getElementById('gallery');

    const state = { layers: [], traits: [], previewCount: 24, supply: 5000 };

    function addLayer(name=`Layer ${state.layers.length+1}`){
      const id = crypto.randomUUID();
      state.layers.push({ id, name, traits: [] });
      renderLayers();
    }
    function moveLayer(idx, dir){
      const j = idx + dir; if(j<0 || j>=state.layers.length) return; const tmp = state.layers[idx]; state.layers[idx]=state.layers[j]; state.layers[j]=tmp; renderLayers();
    }
    function deleteLayer(idx){ state.layers.splice(idx,1); renderLayers(); }
    function addTrait(){
      if(state.layers.length===0){ addLayer('Base'); }
      const l = state.layers[state.layers.length-1];
      const t = { id: crypto.randomUUID(), name: `Trait ${l.traits.length+1}`, weight: Math.max(1, Math.round(Math.random()*10)), cap: 0, rarity: 'Common' };
      l.traits.push(t); renderLayers();
    }
    function addTraitToLayer(li){ const l=state.layers[li]; if(!l) return; l.traits.push({ id: crypto.randomUUID(), name:`Trait ${l.traits.length+1}`, weight:1, cap:0, rarity:'Common' }); renderLayers(); }
    function deleteTrait(li, ti){ const l=state.layers[li]; if(!l) return; l.traits.splice(ti,1); renderLayers(); }
    function renderLayers(){
      layersEl.innerHTML = '';
      state.layers.forEach((l,li)=>{
        const box = document.createElement('div'); box.className='layer';
        const header = document.createElement('div');
        header.innerHTML = `<div style="display:flex;align-items:center;gap:.5rem;justify-content:space-between">
            <h4 contenteditable data-li="${li}" class="l-name" title="Rename layer">${l.name}</h4>
            <div style="display:flex;gap:.4rem">
              <button class="btn l-up" data-li="${li}" title="Move up">▲</button>
              <button class="btn l-down" data-li="${li}" title="Move down">▼</button>
              <button class="btn l-add" data-li="${li}" title="Add trait">+ Trait</button>
              <button class="btn l-del" data-li="${li}" title="Delete layer">✕</button>
            </div>
          </div>`;
        box.appendChild(header);
        const traits = document.createElement('div'); traits.className='traits';
        l.traits.forEach((t,ti)=>{
          const row = document.createElement('div'); row.className='trait';
          row.innerHTML = `<input value="${t.name}" data-li="${li}" data-ti="${ti}" class="t-name" title="Trait name"/>`+
                          `<input type="number" value="${t.weight}" min="1" data-li="${li}" data-ti="${ti}" class="t-weight" title="Weight"/>`+
                          `<input type="number" value="${t.cap||0}" min="0" data-li="${li}" data-ti="${ti}" class="t-cap" title="Max uses (0 = unlimited)"/>`+
                          `<select data-li="${li}" data-ti="${ti}" class="t-rarity" title="Rarity">
                              <option${t.rarity==='Common'?' selected':''}>Common</option>
                              <option${t.rarity==='Uncommon'?' selected':''}>Uncommon</option>
                              <option${t.rarity==='Rare'?' selected':''}>Rare</option>
                              <option${t.rarity==='Epic'?' selected':''}>Epic</option>
                           </select>`+
                          `<button class="btn t-del" data-li="${li}" data-ti="${ti}" title="Remove trait">Remove</button>`;
          traits.appendChild(row);
        });
        box.appendChild(traits);
        layersEl.appendChild(box);
      });
      bindTraitInputs();
    }
    function bindTraitInputs(){
      document.querySelectorAll('.t-name').forEach(i=> i.addEventListener('input', ()=>{ const li=+i.dataset.li, ti=+i.dataset.ti; state.layers[li].traits[ti].name=i.value; }));
      document.querySelectorAll('.t-weight').forEach(i=> i.addEventListener('input', ()=>{ const li=+i.dataset.li, ti=+i.dataset.ti; state.layers[li].traits[ti].weight=Math.max(1,+i.value||1); }));
      document.querySelectorAll('.t-cap').forEach(i=> i.addEventListener('input', ()=>{ const li=+i.dataset.li, ti=+i.dataset.ti; state.layers[li].traits[ti].cap=Math.max(0,+i.value||0); }));
      document.querySelectorAll('.t-rarity').forEach(i=> i.addEventListener('change', ()=>{ const li=+i.dataset.li, ti=+i.dataset.ti; state.layers[li].traits[ti].rarity=i.value; }));
      document.querySelectorAll('.t-del').forEach(b=> b.addEventListener('click', ()=> deleteTrait(+b.dataset.li, +b.dataset.ti)));
      document.querySelectorAll('.l-up').forEach(b=> b.addEventListener('click', ()=> moveLayer(+b.dataset.li, -1)));
      document.querySelectorAll('.l-down').forEach(b=> b.addEventListener('click', ()=> moveLayer(+b.dataset.li, +1)));
      document.querySelectorAll('.l-del').forEach(b=> b.addEventListener('click', ()=> deleteLayer(+b.dataset.li)));
      document.querySelectorAll('.l-add').forEach(b=> b.addEventListener('click', ()=> addTraitToLayer(+b.dataset.li)));
      document.querySelectorAll('.l-name').forEach(h=> h.addEventListener('input', ()=>{ const li=+h.getAttribute('data-li'); state.layers[li].name = h.textContent.trim()||state.layers[li].name; }));
    }

    function computeRarity(){
      // compute normalized weights per trait to estimate rarity distribution (Legendary removed)
      const rarMap = { Common:1, Uncommon:1.5, Rare:2, Epic:3 };
      const summary = [];
      state.layers.forEach(l=>{
        l.traits.forEach(t=>{ summary.push({ name:`${l.name}:${t.name}`, score: t.weight * (rarMap[t.rarity]||1) }); });
      });
      summary.sort((a,b)=>b.score-a.score);
      alert('Rarity computed for '+summary.length+' traits. Top: '+ (summary[0]?.name||'N/A'));
    }

    function randColor(){ const h=120+Math.random()*40; return `hsl(${h},70%,${50+Math.random()*30}%)`; }
    function genToken(seed){
      // deterministic simple art based on seed
      const r = (n)=> Math.abs(Math.sin(seed*n)*10000)%1; const cnv=document.createElement('canvas'); cnv.width=512; cnv.height=512; const ctx=cnv.getContext('2d');
      ctx.fillStyle='#06110a'; ctx.fillRect(0,0,cnv.width,cnv.height);
      for(let i=0;i<6;i++){ ctx.fillStyle = randColor(); const x=r(i+.1)*512; const y=r(i+.2)*512; const s=40+r(i+.3)*220; ctx.beginPath(); ctx.arc(x,y,s,0,Math.PI*2); ctx.fill(); }
      ctx.globalCompositeOperation='overlay';
      for(let i=0;i<5;i++){ ctx.strokeStyle=randColor(); ctx.lineWidth=2+r(i+.4)*6; ctx.beginPath(); ctx.moveTo(r(i+.5)*512, r(i+.6)*512); ctx.lineTo(r(i+.7)*512, r(i+.8)*512); ctx.stroke(); }
      ctx.globalCompositeOperation='source-over';
      return cnv;
    }
    function generatePreview(){
      // Remove all preview thumbnails
      previewEl.innerHTML='';
    }
    function exportMetadata(){
      const name=document.getElementById('colName').value||'Quantum NFT'; const symbol=document.getElementById('colSymbol').value||'QNFT'; const base=document.getElementById('colBase').value||''; const royalty=+document.getElementById('colRoyalty').value||0; const supply=+document.getElementById('colSupply').value||state.supply;
      const items = Array.from({length: Math.min(200, supply)}, (_,i)=> ({ id:i+1, name:`${name} #${i+1}`, description:`${name} token ${i+1}`, image:`${base}${i+1}.png`, attributes:[] }));
      const blob=new Blob([JSON.stringify({ name, symbol, royalty, supply, base, items }, null, 2)], {type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download = `${symbol}-metadata.json`; a.click(); URL.revokeObjectURL(a.href);
    }

    function deploy(){
      const name=document.getElementById('colName').value||'Quantum NFT'; const symbol=document.getElementById('colSymbol').value||'QNFT'; const base=document.getElementById('colBase').value||''; const royalty=+document.getElementById('colRoyalty').value||0; const supply=+document.getElementById('colSupply').value||state.supply;
      const manifest = { type:'nft', standard:'ERC721', name, symbol, base, royalty, supply, timestamp: Date.now() };
      fetch('/api/launchpad/deploy', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(manifest) })
        .then(r=>r.json()).then(j=> alert(`Deployment queued: ${j.taskId||'task'} on ${j.network||'network'}`))
        .catch(err=> alert('Deploy failed: '+err));
    }

    document.getElementById('btnAddLayer').addEventListener('click', addLayer);
    document.getElementById('btnAddTrait').addEventListener('click', addTrait);
    document.getElementById('btnRarity').addEventListener('click', computeRarity);
    document.getElementById('btnPreview').addEventListener('click', generatePreview);
    document.getElementById('btnExport').addEventListener('click', exportMetadata);
    document.getElementById('btnDeploy').addEventListener('click', deploy);

    // Merkle root computation (sorted pairs) from whitelist
    function parseAddresses(text){
      return text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).map(a=> a.toLowerCase());
    }
    function computeMerkleRoot(addresses){
      const { utils } = ethers;
      let level = addresses.map(a => utils.keccak256(utils.solidityPack(['address'], [a])));
      if(level.length===0) return '0x' + '0'.repeat(64);
      while(level.length>1){
        const next=[];
        for(let i=0;i<level.length;i+=2){
          const L = level[i]; const R = level[i+1] || L;
          const [a,b] = [L,R].sort();
          const packed = utils.solidityPack(['bytes32','bytes32'], [a,b]);
          next.push(utils.keccak256(packed));
        }
        level = next;
      }
      return level[0];
    }
    document.getElementById('btnMerkle').addEventListener('click', ()=>{
      const list = parseAddresses(document.getElementById('wlList').value||'');
      try { const root = computeMerkleRoot(list); document.getElementById('wlRoot').value = root; document.getElementById('genNote').textContent = `Merkle root computed for ${list.length} addresses.`; }
      catch(err){ alert('Failed to compute root: '+(err?.message||err)); }
    });

    // Rules parsing and validation (basic syntax check)
    function parseRules(text){
      return text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).map(line=>{
        const parts = line.split('!='); if(parts.length!==2) return null;
        const left = parts[0].trim(); const right = parts[1].trim();
        const [lLayer,lTrait] = left.split(':').map(s=>s.trim());
        const [rLayer,rTrait] = right.split(':').map(s=>s.trim());
        if(!lLayer||!lTrait||!rLayer||!rTrait) return null; return { lLayer,lTrait,rLayer,rTrait };
      }).filter(Boolean);
    }
    document.getElementById('btnCheckRules').addEventListener('click', ()=>{
      const rules = parseRules(document.getElementById('rules').value||'');
      const valid = rules.length; const s = document.getElementById('rulesStatus');
      s.textContent = valid ? `${valid} rule(s)` : 'No rules';
      s.style.background = valid ? 'rgba(34,197,94,.15)' : 'var(--glass)';
    });

    // Rarity visualization (Chart.js)
    let rarChart = null;
    function raritySummary(){
      const labels=[]; const data=[];
      state.layers.forEach(l=>{
        l.traits.forEach(t=>{ labels.push(`${l.name}:${t.name}`); data.push(Math.max(1, +t.weight||1)); });
      });
      return { labels, data };
    }
    function updateRarityChart(){
      const ctx = document.getElementById('rarChart').getContext('2d');
      const { labels, data } = raritySummary();
      if(rarChart) rarChart.destroy();
      rarChart = new Chart(ctx, {
        type:'bar',
        data:{ labels, datasets:[{ label:'Weight', data, backgroundColor:'#22c55e' }]},
        options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ x:{ ticks:{ color:getComputedStyle(document.documentElement).getPropertyValue('--chart-tick') }, grid:{ color:getComputedStyle(document.documentElement).getPropertyValue('--chart-grid-weak') } }, y:{ ticks:{ color:getComputedStyle(document.documentElement).getPropertyValue('--chart-tick') }, grid:{ color:getComputedStyle(document.documentElement).getPropertyValue('--chart-grid') } } } }
      });
    }
    document.getElementById('btnRarity').addEventListener('click', ()=>{ computeRarity(); updateRarityChart(); });

    // Toggle 1155 per-token supply field
    (function setupStandardToggle(){
      const sel = document.getElementById('colStandard'); const f = document.getElementById('erc1155SupplyField');
      function apply(){ if(!sel||!f) return; f.style.display = sel.value==='ERC1155' ? '' : 'none'; }
      sel?.addEventListener('change', apply); apply();
    })();

    // Bulk generator & ZIP export
    let generatedZip = null; // JSZip instance
    async function generateCollection(){
      const count = Math.max(1, parseInt(document.getElementById('genCount').value||'1'));
      const size  = Math.max(64, parseInt(document.getElementById('genSize').value||'512'));
      const enforce = document.getElementById('genUnique').checked;
      const withImages = document.getElementById('genImages').checked;
      const useWorker = document.getElementById('genWorker')?.checked;
      const bar = document.getElementById('genBar'); const note = document.getElementById('genNote');
      const name = document.getElementById('colName').value || 'Quantum NFT';
      const symbol = document.getElementById('colSymbol').value || 'QNFT';
      const base = document.getElementById('colBase').value || 'ipfs://placeholder/';
      const rules = parseRules(document.getElementById('rules').value||'');

      // simple rule checker
      function violates(attrs){
        return rules.some(r=> attrs.some(a=> a.layer===r.lLayer && a.value===r.lTrait) && attrs.some(a=> a.layer===r.rLayer && a.value===r.rTrait));
      }
      // pick weighted trait from a layer, respecting caps
      const capKey=(li,ti)=> `${li}:${ti}`;
      const used = new Map();
      function underCap(li,ti,cap){ if(!cap) return true; const k=capKey(li,ti); const u=used.get(k)||0; return u<cap; }
      function markUsed(li,ti){ const k=capKey(li,ti); used.set(k, (used.get(k)||0)+1 ); }
      function pick(li, layer){
        const avail = layer.traits.map((t,ti)=>({t,ti})).filter(x=> underCap(li,x.ti, Math.max(0, +x.t.cap||0)));
        const pool = (avail.length? avail : layer.traits.map((t,ti)=>({t,ti})));
        const total = pool.reduce((s,x)=> s + Math.max(1, +x.t.weight||1), 0);
        let r = Math.random()*total; for(const x of pool){ const w=Math.max(1, +x.t.weight||1); if(r<w) return x; r-=w; } return pool[pool.length-1];
      }

      const zip = new JSZip(); const metaFolder = zip.folder('metadata'); const imgFolder = withImages ? zip.folder('images') : null;
      const usedDNA = new Set();

      // Worker path (metadata in worker; images on main if requested)
      if(useWorker){
        try{
          const worker = new Worker('nft-worker.js');
          const payload = { count, layers: state.layers, rules, enforce };
          const attrsList = await new Promise((resolve, reject)=>{
            worker.onmessage = (e)=>{
              const msg = e.data||{}; const type=msg.type; const data=msg.data;
              if(type==='progress'){ const pct = Math.round((data.done/count)*100); bar.style.width=pct+'%'; note.textContent = `Generated ${data.done}/${count}`; }
              if(type==='done'){ resolve(data.items); worker.terminate(); }
            };
            worker.onerror = (err)=>{ reject(err); worker.terminate(); };
            worker.postMessage(payload);
          });
          for(let i=1;i<=attrsList.length;i++){
            const attrs = attrsList[i-1];
            const dna = ethers.utils.id(JSON.stringify(attrs));
            const meta = { name: `${name} #${i}`, description: `${name} token ${i}`, image: `${base}${i}.png`, attributes: attrs.map(a=>({ trait_type:a.layer, value:a.value })) };
            metaFolder.file(`${i}.json`, JSON.stringify(meta, null, 2));
            if(withImages){
              const seed = parseInt(ethers.BigNumber.from(ethers.utils.arrayify(dna)).mod(1000000007).toString());
              const cnv = genToken(seed); cnv.width = cnv.height = size; const url = cnv.toDataURL('image/png');
              const bstr = atob(url.split(',')[1]); const u8 = new Uint8Array(bstr.length); for(let j=0;j<bstr.length;j++) u8[j]=bstr.charCodeAt(j);
              imgFolder.file(`${i}.png`, u8, {binary:true});
            }
          }
          generatedZip = zip; document.getElementById('btnDownload').disabled = false; note.textContent = `Done. ${attrsList.length} items ready.`; return;
        }catch(err){ console.error(err); note.textContent = 'Worker failed, falling back to main thread.'; }
      }

      for(let i=1;i<=count;i++){
        // build attributes
        let tries=0; let attrs; let dna;
        do{
          attrs = state.layers.map((l,li)=>{
            if(!l.traits.length) return { layer:l.name, value:`T${Math.floor(Math.random()*10)}` };
            const sel = pick(li,l); markUsed(li, sel.ti); return { layer: l.name, value: sel.t.name };
          });
          dna = ethers.utils.id(JSON.stringify(attrs));
          tries++;
          if(tries>50) break; // avoid infinite loop
        } while( (enforce && usedDNA.has(dna)) || violates(attrs) );
        usedDNA.add(dna);

        // metadata
        const meta = { name: `${name} #${i}`, description: `${name} token ${i}`, image: `${base}${i}.png`, attributes: attrs.map(a=>({ trait_type:a.layer, value:a.value })) };
        metaFolder.file(`${i}.json`, JSON.stringify(meta, null, 2));

        // thumbnail
        if(withImages){
          const seed = parseInt(ethers.BigNumber.from(ethers.utils.arrayify(dna)).mod(1000000007).toString());
          const cnv = genToken(seed); cnv.width = cnv.height = size; const url = cnv.toDataURL('image/png');
          const bstr = atob(url.split(',')[1]); const u8 = new Uint8Array(bstr.length); for(let j=0;j<bstr.length;j++) u8[j]=bstr.charCodeAt(j);
          imgFolder.file(`${i}.png`, u8, {binary:true});
        }
        const pct = Math.round((i/count)*100); bar.style.width = pct+'%'; note.textContent = `Generated ${i}/${count}`;
        await new Promise(r=> setTimeout(r, 0)); // yield to UI
      }

      generatedZip = zip; document.getElementById('btnDownload').disabled = false; note.textContent = `Done. ${count} items ready.`;
    }

    async function downloadZip(){
      if(!generatedZip){ alert('Nothing generated yet.'); return; }
      const symbol = document.getElementById('colSymbol').value || 'QNFT';
      const blob = await generatedZip.generateAsync({ type:'blob' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${symbol}-collection.zip`; a.click(); URL.revokeObjectURL(a.href);
    }

    document.getElementById('btnGenerate').addEventListener('click', generateCollection);
    document.getElementById('btnDownload').addEventListener('click', downloadZip);

    // IPFS upload using web3.storage
    async function zipToFiles(zip, prefix=''){
      const files=[]; const entries=[];
      zip.forEach((path, entry)=>{ entries.push({ path, entry }); });
      for(const {path, entry} of entries){ if(entry.dir) continue; const blob = await entry.async('blob'); files.push({ path: (prefix? `${prefix}/`:'') + path, blob }); }
      return files;
    }
    async function putFiles(files){
      const token=(document.getElementById('ipfsToken').value||'').trim(); if(!token){ alert('Enter web3.storage token.'); return ''; }
      const { Web3Storage, File } = (window._Web3Storage||{});
      if(!Web3Storage||!File){ alert('web3.storage bundle not loaded.'); return ''; }
      const client=new Web3Storage({ token });
      const toFile = (f)=> new File([f.blob], f.path);
      const cid = await client.put(files.map(toFile), { wrapWithDirectory:true, name:'zyra-collection' });
      return cid;
    }
    document.getElementById('btnUploadMeta')?.addEventListener('click', async()=>{
      if(!generatedZip){ alert('Generate a collection first.'); return; }
      const zip = generatedZip; const all = await zipToFiles(zip); const metaOnly = all.filter(f=> f.path.startsWith('metadata/'));
      const cid = await putFiles(metaOnly); if(cid){ document.getElementById('ipfsCid').value = cid; alert('Metadata uploaded to IPFS.'); }
    });
    document.getElementById('btnUploadAll')?.addEventListener('click', async()=>{
      if(!generatedZip){ alert('Generate a collection first.'); return; }
      const zip = generatedZip; const all = await zipToFiles(zip);
      const cid = await putFiles(all); if(cid){ document.getElementById('ipfsCid').value = cid; alert('ZIP contents uploaded to IPFS.'); }
    });

    // Extend deploy manifest with advanced fields
    (function extendDeploy(){
      const origDeploy = deploy;
      deploy = function(){
        const name=document.getElementById('colName').value||'Quantum NFT';
        const symbol=document.getElementById('colSymbol').value||'QNFT';
        const base=document.getElementById('colBase').value||'';
        const royalty=+document.getElementById('colRoyalty').value||0;
        const supply=+document.getElementById('colSupply').value||state.supply;
        const standard=document.getElementById('colStandard').value||'ERC721';
        const perTokenSupply = +document.getElementById('col1155Supply')?.value||1;
        const price=+document.getElementById('colPrice').value||0;
        const maxPerWallet=+document.getElementById('colMax').value||0;
        const saleStart=(document.getElementById('colStart').value||'');
        const whitelistRoot=(document.getElementById('wlRoot').value||'');
        const manifest = { type:'nft', standard, name, symbol, base, royalty, supply, perTokenSupply, price, maxPerWallet, saleStart, whitelistRoot, layers: state.layers, timestamp: Date.now() };
        fetch('/api/launchpad/deploy', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(manifest) })
          .then(r=>r.json()).then(j=> alert(`Deployment queued: ${j.taskId||'task'} on ${j.network||'network'}`))
          .catch(err=> alert('Deploy failed: '+err));
      }
    })();

    // initial state
    addLayer('Base'); addTrait(); addTrait(); generatePreview();
  </script>
  <script type="module">
    import { Web3Storage, File } from 'https://cdn.jsdelivr.net/npm/web3.storage/dist/bundle.esm.min.js';
    window._Web3Storage = { Web3Storage, File };
  </script>
</body>
</html>
