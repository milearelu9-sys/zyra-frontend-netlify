<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ZYRA | NFT Marketplace</title>
  <meta name="description" content="ZYRA NFT Marketplace — list, buy, sell, and explore collections with quantum UI." />
  <meta name="theme-color" content="#22c55e" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@400;600;700&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
  <style>
    :root { --q-primary:#00ff95; --q-secondary:#16a34a; --q-accent:#84cc16; --q-success:#22c55e; --q-danger:#ef4444; --q-bg-0:#050607; --q-bg-1:#0a0f0a; --glass:rgba(255,255,255,.06); --glass-strong:rgba(255,255,255,.10); --glass-border:rgba(255,255,255,.14); --text:#e8fcea; --text-dim:#a9f5c9; --shadow-q:0 10px 50px rgba(34,197,94,.25); }
    *{box-sizing:border-box}
    body{margin:0;color:var(--text);background: radial-gradient(1200px 800px at 15% 10%, #0b1a12 0%, transparent 60%), radial-gradient(1000px 900px at 95% 0%, #08140c 0%, transparent 55%), linear-gradient(180deg, #040605 0%, #040605 100%); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto; }
    header{position:sticky;top:0;z-index:50;backdrop-filter:blur(12px);background:linear-gradient(180deg,rgba(8,12,24,.85),rgba(8,12,24,.6));border-bottom:1px solid var(--glass-border)}
    .wrap{max-width:1200px;margin:0 auto;padding:.9rem 1.25rem;display:flex;align-items:center;gap:1rem}
    .brand{display:flex;align-items:center;gap:.75rem;text-decoration:none;color:var(--text)}
    .logo{width:44px;height:44px;border-radius:14px;position:relative;overflow:hidden;box-shadow:0 0 0 1px #145532,var(--shadow-q);background:radial-gradient(120% 120% at 10% 10%,#0f2a1a 0%,#0a1510 60%,#070e0a 100%)}
    .logo::after{content:'Z';position:absolute;inset:0;display:grid;place-items:center;font-family:Orbitron;font-weight:900;font-size:22px;color:#eafff2;text-shadow:0 0 12px #22ff88;letter-spacing:.08em}
    nav{margin-left:auto;display:flex;gap:.5rem;flex-wrap:wrap}
    .nav-btn{position:relative;padding:.55rem .9rem;border-radius:12px;border:1px solid var(--glass-border);background:var(--glass);color:var(--text);font-weight:600;cursor:pointer}
    .pill{padding:.45rem .7rem;border-radius:999px;background:var(--glass);border:1px solid var(--glass-border);font-family:'JetBrains Mono',monospace;font-size:.85rem;color:var(--text-dim)}
    .cta{padding:.6rem 1rem;border-radius:12px;background:linear-gradient(90deg,var(--q-primary),var(--q-secondary));border:0;color:#021412;font-weight:800;letter-spacing:.04em;cursor:pointer}

    main{max-width:1200px;margin:1.2rem auto 2rem;padding:0 1.25rem}
    .h-title{font-family:Orbitron,Inter,sans-serif;font-weight:900;font-size:clamp(1.8rem,4.5vw,3rem);margin:.2rem 0 .2rem;letter-spacing:.06em;background:linear-gradient(120deg,#eafff2 10%,var(--q-primary) 45%,var(--q-secondary) 60%,#e7ffe3 90%);-webkit-background-clip:text;background-clip:text;color:transparent}
    .h-sub{color:var(--text-dim);margin:0 0 1rem}

    .filters{display:grid;grid-template-columns: 1fr 1fr 1fr auto auto; gap:.6rem; margin:1rem 0}
    .filters input,.filters select{padding:.6rem .7rem;border-radius:12px;border:1px solid var(--glass-border);background:rgba(0,0,0,.25);color:var(--text)}

    .grid{display:grid;grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap:1rem}
    .card{background:var(--glass);border:1px solid var(--glass-border);border-radius:16px;overflow:hidden}
    .card canvas{display:block;width:100%;height:auto;background:#06110a}
    .row{display:flex;justify-content:space-between;align-items:center;padding:.6rem .8rem}
    .name{font-weight:800}
    .price{font-family:'JetBrains Mono',monospace;color:#a9f5c9}
    .act{display:flex;gap:.4rem}
    .btn{padding:.45rem .7rem;border-radius:12px;border:1px solid var(--glass-border);background:var(--glass);color:var(--text);font-weight:700;cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,var(--q-primary),var(--q-secondary));border:0;color:#021412}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:60}
    .dialog{width:min(520px,92vw);background:var(--glass);border:1px solid var(--glass-border);border-radius:16px;padding:1rem}
    .dialog h3{margin:.2rem 0 1rem}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <a class="brand" href="index.html"><div class="logo"></div><div class="wordmark" style="font-family:Orbitron;font-weight:900;letter-spacing:.12em;"> <span style="background:linear-gradient(90deg,var(--q-primary),var(--q-secondary));-webkit-background-clip:text;background-clip:text;color:transparent;">ZYRA</span>&nbsp;MARKET</div></a>
      <nav aria-label="Primary">
        <a class="nav-btn" href="index.html">Home</a>
        <a class="nav-btn" href="defi.html">DeFi</a>
        <a class="nav-btn" href="analytics.html">Analytics</a>
        <a class="nav-btn" href="nft.html">NFT</a>
        <span class="nav-btn" aria-current="page">Marketplace</span>
      </nav>
      <div class="wallet">
        <div id="walletState" class="pill">Not Connected</div>
        <button id="walletBtn" class="cta">Connect Wallet</button>
      </div>
    </div>
  </header>

  <main>
    <h1 class="h-title">NFT Marketplace</h1>
    <p class="h-sub">Browse, list and trade NFTs with quantum‑smooth UI. Demo data is generated locally.</p>

    <section class="filters">
      <input id="q" placeholder="Search by name or #id"/>
      <select id="sort" title="Sort by">
        <option value="recent">Recently listed</option>
        <option value="priceAsc">Price: Low to High</option>
        <option value="priceDesc">Price: High to Low</option>
      </select>
      <select id="coll" title="Filter by collection">
        <option value="all">All Collections</option>
      </select>
      <button id="btnList" class="btn">List NFT</button>
      <input id="marketAddr" placeholder="Marketplace address 0x..." title="Marketplace contract address"/>
      <button id="saveMarket" class="btn" title="Save marketplace address">Save</button>
    </section>
    
    <section class="grid" id="grid"></section>
  </main>

  <div class="modal" id="modal">
    <div class="dialog">
      <h3>List an NFT</h3>
      <div class="field"><label>Contract</label><input id="mContract" placeholder="0x..." style="width:100%;padding:.6rem .7rem;border-radius:12px;border:1px solid var(--glass-border);background:rgba(0,0,0,.25);color:var(--text)"/></div>
      <div class="field"><label>Token ID</label><input id="mTokenId" type="number" min="0" value="1" style="width:100%;padding:.6rem .7rem;border-radius:12px;border:1px solid var(--glass-border);background:rgba(0,0,0,.25);color:var(--text)"/></div>
      <div class="field"><label>Standard</label>
        <select id="mStandard" title="Token standard" style="width:100%;padding:.6rem .7rem;border-radius:12px;border:1px solid var(--glass-border);background:rgba(0,0,0,.25);color:var(--text)">
          <option value="ERC721" selected>ERC-721</option>
          <option value="ERC1155">ERC-1155</option>
        </select>
      </div>
      <div class="field" id="mAmountWrap" style="display:none"><label>Amount (ERC-1155)</label><input id="mAmount" type="number" min="1" value="1" style="width:100%;padding:.6rem .7rem;border-radius:12px;border:1px solid var(--glass-border);background:rgba(0,0,0,.25);color:var(--text)"/></div>
      <div class="field"><label>Price (ETH)</label><input id="mPrice" type="number" min="0" step="0.0001" value="0.05" style="width:100%;padding:.6rem .7rem;border-radius:12px;border:1px solid var(--glass-border);background:rgba(0,0,0,.25);color:var(--text)"/></div>
      <div class="row" style="margin-top:.6rem;justify-content:flex-end"><button class="btn" id="mCancel">Cancel</button><button class="btn-primary" id="mSave" style="margin-left:.5rem">Save</button></div>
    </div>
  </div>

  <div class="modal" id="offerModal">
    <div class="dialog">
      <h3>Make an Offer</h3>
      <div class="field"><label>Price (ETH)</label><input id="oPrice" type="number" min="0" step="0.0001" value="0.03" style="width:100%;padding:.6rem .7rem;border-radius:12px;border:1px solid var(--glass-border);background:rgba(0,0,0,.25);color:var(--text)"/></div>
      <div class="field"><label>Expires (minutes)</label><input id="oExpiry" type="number" min="5" value="60" style="width:100%;padding:.6rem .7rem;border-radius:12px;border:1px solid var(--glass-border);background:rgba(0,0,0,.25);color:var(--text)"/></div>
      <div class="row" style="margin-top:.6rem;justify-content:flex-end"><button class="btn" id="oCancel">Cancel</button><button class="btn-primary" id="oSave" style="margin-left:.5rem">Submit</button></div>
    </div>
  </div>

  <div class="modal" id="aucModal">
    <div class="dialog">
      <h3>Start Auction</h3>
      <div class="field"><label>Start Price (ETH)</label><input id="aPrice" type="number" min="0" step="0.0001" value="0.01" style="width:100%;padding:.6rem .7rem;border-radius:12px;border:1px solid var(--glass-border);background:rgba(0,0,0,.25);color:var(--text)"/></div>
      <div class="field"><label>Duration (minutes)</label><input id="aDur" type="number" min="10" value="120" style="width:100%;padding:.6rem .7rem;border-radius:12px;border:1px solid var(--glass-border);background:rgba(0,0,0,.25);color:var(--text)"/></div>
      <div class="row" style="margin-top:.6rem;justify-content:flex-end"><button class="btn" id="aCancel">Cancel</button><button class="btn-primary" id="aSave" style="margin-left:.5rem">Start</button></div>
    </div>
  </div>

  <script>
    // Wallet minimal (exposes provider/signer)
    (function wallet(){
      const btn=document.getElementById('walletBtn'); const state=document.getElementById('walletState'); let connected=false; let addr='';
      async function connect(){ if(typeof window.ethereum==='undefined'){ alert('MetaMask not detected.'); return; } try{ const provider=new ethers.providers.Web3Provider(window.ethereum,'any'); await provider.send('eth_requestAccounts',[]); const signer=provider.getSigner(); addr=await signer.getAddress(); connected=true; state.textContent=addr.slice(0,6)+'...'+addr.slice(-4); state.style.background='rgba(34,197,94,.15)'; btn.textContent='Disconnect'; const bal=await provider.getBalance(addr); state.title = `Balance: ${ethers.utils.formatEther(bal)} ETH`; window.ethProvider=provider; window.ethSigner=signer; }catch(err){ alert('Wallet connection failed: '+(err?.message||err)); } }
      function disconnect(){ connected=false; addr=''; state.textContent='Not Connected'; state.style.background='var(--glass)'; state.title=''; btn.textContent='Connect Wallet'; window.ethProvider=undefined; window.ethSigner=undefined; }
      btn.addEventListener('click', async()=>{ if(!connected) await connect(); else disconnect(); });
      window.getWallet=()=>({ connected, addr });
    })();

    // Minimal ABIs and helpers (ERC-721/1155 + extended Marketplace)
    const ERC721_ABI=[
      "function isApprovedForAll(address owner,address operator) view returns (bool)",
      "function setApprovalForAll(address operator,bool approved)",
      "function ownerOf(uint256 tokenId) view returns (address)"
    ];
    const ERC1155_ABI=[
      "function isApprovedForAll(address account,address operator) view returns (bool)",
      "function setApprovalForAll(address operator,bool approved)",
      "function balanceOf(address account,uint256 id) view returns (uint256)"
    ];
    const MARKET_ABI=[
      // fixed price
      "function list(address nft,uint256 tokenId,uint256 priceWei) external",
      "function list1155(address nft,uint256 tokenId,uint256 amount,uint256 priceWei) external",
      "function cancel(address nft,uint256 tokenId) external",
      "function buy(address nft,uint256 tokenId) external payable",
      "function buy1155(address nft,uint256 tokenId,uint256 amount) external payable",
      // offers
      "function makeOffer(address nft,uint256 tokenId,uint256 priceWei,uint256 expiry) external payable",
      "function acceptOffer(address nft,uint256 tokenId,address buyer) external",
      // auctions
      "function startAuction(address nft,uint256 tokenId,uint256 startPriceWei,uint256 endTime) external",
      "function bid(address nft,uint256 tokenId) external payable",
      "function endAuction(address nft,uint256 tokenId) external",
      // views
      "function getListing(address nft,uint256 tokenId) view returns (address seller,uint256 priceWei,uint256 amount)",
      // events (optional)
      "event Listed(address indexed nft,uint256 indexed tokenId,address indexed seller,uint256 priceWei,uint256 amount)",
      "event Cancelled(address indexed nft,uint256 indexed tokenId)",
      "event Bought(address indexed nft,uint256 indexed tokenId,address indexed buyer,uint256 amount,uint256 priceWei)",
      "event OfferMade(address indexed nft,uint256 indexed tokenId,address indexed buyer,uint256 priceWei,uint256 expiry)",
      "event AuctionStarted(address indexed nft,uint256 indexed tokenId,address indexed seller,uint256 startPriceWei,uint256 endTime)",
      "event BidPlaced(address indexed nft,uint256 indexed tokenId,address indexed bidder,uint256 amountWei)",
      "event AuctionEnded(address indexed nft,uint256 indexed tokenId,address winner,uint256 amountWei)"
    ];
    const marketAddrInput = ()=> document.getElementById('marketAddr');
    function getMarketAddress(){ return (marketAddrInput()?.value?.trim()) || localStorage.getItem('marketAddr') || ''; }
    function setMarketAddress(v){ localStorage.setItem('marketAddr', v); if(marketAddrInput()) marketAddrInput().value=v; }
    document.getElementById('saveMarket').addEventListener('click', ()=>{ const v=marketAddrInput().value.trim(); if(/^0x[a-fA-F0-9]{40}$/.test(v)){ setMarketAddress(v); alert('Marketplace address saved.'); attachMarketListeners(); } else { alert('Invalid address.'); } });
    // hydrate input from storage on load
    (function(){ const v=localStorage.getItem('marketAddr'); if(v && marketAddrInput()) marketAddrInput().value=v; })();
    async function ensureApproval(nftAddr, owner, operator, standard='ERC721'){
      const abi = standard==='ERC1155' ? ERC1155_ABI : ERC721_ABI;
      const nft=new ethers.Contract(nftAddr, abi, window.ethSigner||window.ethProvider);
      const ok=await nft.isApprovedForAll(owner, operator); if(!ok){ const tx=await nft.setApprovalForAll(operator,true); await tx.wait(); }
    }

    // Demo data generation (augmented with optional nft/tokenId for on-chain items)
    const items=[]; const collections=['Quantum NFT','Zyra Arts'];
    function randColor(){ const h=120+Math.random()*40; return `hsl(${h},70%,${50+Math.random()*30}%)`; }
    function art(seed){ const r=(n)=> Math.abs(Math.sin(seed*n)*10000)%1; const cnv=document.createElement('canvas'); cnv.width=600; cnv.height=600; const ctx=cnv.getContext('2d'); ctx.fillStyle='#06110a'; ctx.fillRect(0,0,600,600); for(let i=0;i<6;i++){ ctx.fillStyle=randColor(); const x=r(i+.1)*600; const y=r(i+.2)*600; const s=40+r(i+.3)*220; ctx.beginPath(); ctx.arc(x,y,s,0,Math.PI*2); ctx.fill(); } ctx.globalCompositeOperation='overlay'; for(let i=0;i<5;i++){ ctx.strokeStyle=randColor(); ctx.lineWidth=2+r(i+.4)*6; ctx.beginPath(); ctx.moveTo(r(i+.5)*600, r(i+.6)*600); ctx.lineTo(r(i+.7)*600, r(i+.8)*600); ctx.stroke(); } ctx.globalCompositeOperation='source-over'; return cnv; }
    for(let i=1;i<=18;i++){ items.push({ id:i, name:`Quantum NFT #${i}`, price:(0.02+Math.random()*0.2).toFixed(3), collection: collections[i%collections.length] }); }

    const grid=document.getElementById('grid');
    function render(){
      const q=(document.getElementById('q').value||'').toLowerCase();
      const sort=document.getElementById('sort').value;
      const coll=document.getElementById('coll').value;
      const data = items.filter(x=> x.name.toLowerCase().includes(q) && (coll==='all'||x.collection===coll));
      if(sort==='priceAsc') data.sort((a,b)=> a.price-b.price); else if(sort==='priceDesc') data.sort((a,b)=> b.price-a.price);
      grid.innerHTML='';
      data.forEach(it=>{
        const card=document.createElement('div'); card.className='card';
        const cnv=art(it.id); card.appendChild(cnv);
        const row=document.createElement('div'); row.className='row';
        row.innerHTML=`<div><div class='name'>${it.name}</div><div class='price'>${it.price} ETH</div></div>`;
        const act=document.createElement('div'); act.className='act';
        const buy=document.createElement('button'); buy.className='btn-primary'; buy.textContent='Buy'; buy.onclick=async()=>{
          const maddr=getMarketAddress(); if(maddr && window.ethSigner && it.nft && (it.tokenId!==undefined)){
            try{ const market=new ethers.Contract(maddr, MARKET_ABI, window.ethSigner);
              if(it.standard==='ERC1155'){
                const qty = parseInt(prompt('Quantity to buy?', String(it.amount||1))||'1');
                const tx=await market.buy1155(it.nft, it.tokenId, qty, { value: ethers.utils.parseEther(String(it.price*qty)) }); await tx.wait();
              } else {
                const tx=await market.buy(it.nft, it.tokenId, { value: ethers.utils.parseEther(String(it.price)) }); await tx.wait();
              }
              alert('Purchase complete.');
            }
            catch(err){ alert('Buy failed: '+(err?.message||err)); }
          } else { alert('Demo: Buy '+it.name+' (configure Market address and connect wallet for on-chain)'); }
        };
        const offer=document.createElement('button'); offer.className='btn'; offer.textContent='Offer'; offer.onclick=()=> openOffer(it);
        const auction=document.createElement('button'); auction.className='btn'; auction.textContent='Auction'; auction.onclick=()=> openAuction(it);
        const cancel=document.createElement('button'); cancel.className='btn'; cancel.textContent='Cancel'; cancel.onclick=async()=>{
          const maddr=getMarketAddress(); if(!(maddr && window.ethSigner && it.nft)) return alert('Connect wallet and set marketplace address.');
          try{ const market=new ethers.Contract(maddr, MARKET_ABI, window.ethSigner); const tx=await market.cancel(it.nft, it.tokenId); await tx.wait(); alert('Cancelled.'); }catch(err){ alert('Cancel failed: '+(err?.message||err)); }
        };
        act.appendChild(buy); act.appendChild(offer); act.appendChild(auction); act.appendChild(cancel); row.appendChild(act); card.appendChild(row); grid.appendChild(card);
      });
      const collSel=document.getElementById('coll'); if(collSel.options.length<=1){ collections.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; collSel.appendChild(o); }); }
    }
    render();
    document.getElementById('q').addEventListener('input', render);
    document.getElementById('sort').addEventListener('change', render);
    document.getElementById('coll').addEventListener('change', render);

    // List modal
    const modal=document.getElementById('modal');
    document.getElementById('btnList').addEventListener('click', ()=> modal.style.display='flex');
    document.getElementById('mCancel').addEventListener('click', ()=> modal.style.display='none');
    document.getElementById('mStandard').addEventListener('change', ()=>{ document.getElementById('mAmountWrap').style.display = (document.getElementById('mStandard').value==='ERC1155')? '' : 'none'; });
    document.getElementById('mSave').addEventListener('click', async()=>{
       const c=document.getElementById('mContract').value.trim();
       const t=parseInt(document.getElementById('mTokenId').value||'0');
       const p=parseFloat(document.getElementById('mPrice').value||'0');
      const standard=document.getElementById('mStandard').value;
      const amount = standard==='ERC1155' ? Math.max(1, parseInt(document.getElementById('mAmount').value||'1')) : 1;
       if(!c||isNaN(t)||isNaN(p)){ alert('Please fill all fields.'); return; }
       const maddr=getMarketAddress();
       if(maddr && window.ethSigner){
         try{
          const me=await window.ethSigner.getAddress(); await ensureApproval(c, me, maddr, standard);
          const market=new ethers.Contract(maddr, MARKET_ABI, window.ethSigner);
          let tx;
          if(standard==='ERC1155') tx=await market.list1155(c, t, amount, ethers.utils.parseEther(String(p)));
          else tx=await market.list(c, t, ethers.utils.parseEther(String(p)));
          await tx.wait();
          const id = items.length+1; items.unshift({ id, name:`User NFT #${t}`, price:p.toFixed(3), collection:'User Listing', nft:c, tokenId:t, amount, standard });
           modal.style.display='none'; render();
           return;
         }catch(err){ alert('On-chain listing failed, added as demo instead. '+(err?.message||err)); }
       }
      const id = items.length+1; items.unshift({ id, name:`User NFT #${t}`, price:p.toFixed(3), collection:'User Listing', nft:c, tokenId:t, amount, standard });
       modal.style.display='none'; render();
     });

    // Offer modal handlers
    const offerModal=document.getElementById('offerModal'); let offerTarget=null;
    function openOffer(item){ offerTarget=item; offerModal.style.display='flex'; }
    document.getElementById('oCancel').addEventListener('click', ()=>{ offerModal.style.display='none'; offerTarget=null; });
    document.getElementById('oSave').addEventListener('click', async()=>{
      if(!offerTarget) return; const maddr=getMarketAddress(); if(!(maddr && window.ethSigner)) return alert('Connect wallet and set marketplace address.');
      try{ const price=parseFloat(document.getElementById('oPrice').value||'0'); const mins=parseInt(document.getElementById('oExpiry').value||'60');
        const expiry = Math.floor(Date.now()/1000) + (mins*60);
        const market=new ethers.Contract(maddr, MARKET_ABI, window.ethSigner);
        const tx=await market.makeOffer(offerTarget.nft, offerTarget.tokenId, ethers.utils.parseEther(String(price)), expiry, { value: ethers.utils.parseEther(String(price)) });
        await tx.wait(); alert('Offer submitted.');
      }catch(err){ alert('Offer failed: '+(err?.message||err)); }
      finally{ offerModal.style.display='none'; offerTarget=null; }
    });

    // Auction modal handlers
    const aucModal=document.getElementById('aucModal'); let aucTarget=null;
    function openAuction(item){ aucTarget=item; aucModal.style.display='flex'; }
    document.getElementById('aCancel').addEventListener('click', ()=>{ aucModal.style.display='none'; aucTarget=null; });
    document.getElementById('aSave').addEventListener('click', async()=>{
      if(!aucTarget) return; const maddr=getMarketAddress(); if(!(maddr && window.ethSigner)) return alert('Connect wallet and set marketplace address.');
      try{ const start=parseFloat(document.getElementById('aPrice').value||'0'); const mins=parseInt(document.getElementById('aDur').value||'120');
        const endTime = Math.floor(Date.now()/1000) + (mins*60);
        const market=new ethers.Contract(maddr, MARKET_ABI, window.ethSigner);
        const tx=await market.startAuction(aucTarget.nft, aucTarget.tokenId, ethers.utils.parseEther(String(start)), endTime);
        await tx.wait(); alert('Auction started.');
      }catch(err){ alert('Auction failed: '+(err?.message||err)); }
      finally{ aucModal.style.display='none'; aucTarget=null; }
    });

    // Basic indexer: attach listeners if events exist
    function attachMarketListeners(){
      const maddr=getMarketAddress(); if(!(maddr && window.ethProvider)) return;
      const market=new ethers.Contract(maddr, MARKET_ABI, window.ethProvider);
      try{
        market.on('Listed', (nft, tokenId, seller, priceWei, amount)=>{
          items.unshift({ id: items.length+1, name:`Listed #${tokenId.toString()}`, price: parseFloat(ethers.utils.formatEther(priceWei)).toFixed(3), collection:'On-chain', nft, tokenId: tokenId.toNumber?.()||Number(tokenId), amount: amount?.toNumber?.()||1, standard: (amount && amount.gt && amount.gt(1))? 'ERC1155':'ERC721' });
          render();
        });
        market.on('Cancelled', (nft, tokenId)=>{ const idx = items.findIndex(x=> x.nft===nft && String(x.tokenId)===String(tokenId)); if(idx>=0){ items.splice(idx,1); render(); } });
        market.on('Bought', (nft, tokenId, buyer, amount, priceWei)=>{ /* could mark as sold */ });
      }catch(err){ console.warn('Listener attach failed', err); }
    }
    attachMarketListeners();
  </script>
</body>
</html>
